resources:
- name: qqq-trading-bot
  type: compute.v1.instance
  properties:
    zone: us-central1-c
    machineType: zones/us-central1-c/machineTypes/e2-medium
    disks:
      - deviceName: instance-20250215-130550
        type: PERSISTENT
        boot: true
        autoDelete: true
        initializeParams:
          sourceImage: projects/ubuntu-os-cloud/global/images/family/ubuntu-2204-lts
          diskSizeGb: 20
    networkInterfaces:
      - network: global/networks/default
        accessConfigs:
          - name: External NAT
            type: ONE_TO_ONE_NAT
    metadata:
      items:
      - key: startup-script
        value: |
          #!/bin/bash
          exec > /var/log/startup.log 2>&1
          set -x
          apt-get update
          apt-get upgrade -y

          # Install Docker and Git packages
          apt-get install -y docker.io git

          # Install docker-compose (standalone) - requires curl
          apt-get install -y curl
          curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose

          # Add the user to the docker group
          useradd -m georgepaltakis
          usermod -aG docker georgepaltakis

          # Append a snippet to .bashrc to refresh the shell groups using newgrp
          echo "" >> /home/georgepaltakis/.bashrc
          echo "# Automatically switch to a shell with updated docker group" >> /home/georgepaltakis/.bashrc
          echo "if ! id -nG | grep -qw docker; then exec newgrp docker; fi" >> /home/georgepaltakis/.bashrc

          # Create the target directory (if it doesn't exist) and clone the repository there
          mkdir -p /home/georgepaltakis/QQQ_Trading_Bot
          git clone --depth 1 git@github.com:paltakis/QQQ_Trading_Bot.git /home/georgepaltakis/QQQ_Trading_Bot
            
          # Change ownership of the cloned repository to the desired user
          chown -R georgepaltakis:georgepaltakis /home/georgepaltakis/QQQ_Trading_Bot
            
          # Configure Git settings
          git config --global --add safe.directory /home/georgepaltakis/QQQ_Trading_Bot
          git config --global user.email "paltakis@yahoo.com"
          git config --global user.name "George Paltakis"
          
          # Build the Docker image from the cloned repository
          cd /home/georgepaltakis/QQQ_Trading_Bot
          docker build -t qqq_trading_bot_app:latest .
    serviceAccounts:
      - email: 626418955652-compute@developer.gserviceaccount.com
        scopes:
          - https://www.googleapis.com/auth/devstorage.read_only
          - https://www.googleapis.com/auth/logging.write
          - https://www.googleapis.com/auth/monitoring.write
          - https://www.googleapis.com/auth/service.management.readonly
          - https://www.googleapis.com/auth/servicecontrol
          - https://www.googleapis.com/auth/trace.append
